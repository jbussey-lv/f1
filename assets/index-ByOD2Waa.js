(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=t(n);fetch(n.href,s)}})();function w(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}var f={exports:{}},x;function v(){return x||(x=1,(function(l,e){l.exports=t;function t(i,o){if(!(this instanceof t))return new t(i,o);this.x=i||0,this.y=o||0}t.fromArray=function(i){return new t(i[0]||0,i[1]||0)},t.fromObject=function(i){return new t(i.x||0,i.y||0)},t.prototype.addX=function(i){return this.x+=i.x,this},t.prototype.addY=function(i){return this.y+=i.y,this},t.prototype.add=function(i){return this.x+=i.x,this.y+=i.y,this},t.prototype.addScalar=function(i){return this.x+=i,this.y+=i,this},t.prototype.addScalarX=function(i){return this.x+=i,this},t.prototype.addScalarY=function(i){return this.y+=i,this},t.prototype.subtractX=function(i){return this.x-=i.x,this},t.prototype.subtractY=function(i){return this.y-=i.y,this},t.prototype.subtract=function(i){return this.x-=i.x,this.y-=i.y,this},t.prototype.subtractScalar=function(i){return this.x-=i,this.y-=i,this},t.prototype.subtractScalarX=function(i){return this.x-=i,this},t.prototype.subtractScalarY=function(i){return this.y-=i,this},t.prototype.divideX=function(i){return this.x/=i.x,this},t.prototype.divideY=function(i){return this.y/=i.y,this},t.prototype.divide=function(i){return this.x/=i.x,this.y/=i.y,this},t.prototype.divideScalar=function(i){return i!==0?(this.x/=i,this.y/=i):(this.x=0,this.y=0),this},t.prototype.divideScalarX=function(i){return i!==0?this.x/=i:this.x=0,this},t.prototype.divideScalarY=function(i){return i!==0?this.y/=i:this.y=0,this},t.prototype.invertX=function(){return this.x*=-1,this},t.prototype.invertY=function(){return this.y*=-1,this},t.prototype.invert=function(){return this.invertX(),this.invertY(),this},t.prototype.multiplyX=function(i){return this.x*=i.x,this},t.prototype.multiplyY=function(i){return this.y*=i.y,this},t.prototype.multiply=function(i){return this.x*=i.x,this.y*=i.y,this},t.prototype.multiplyScalar=function(i){return this.x*=i,this.y*=i,this},t.prototype.multiplyScalarX=function(i){return this.x*=i,this},t.prototype.multiplyScalarY=function(i){return this.y*=i,this},t.prototype.normalize=function(){var i=this.length();return i===0?(this.x=1,this.y=0):this.divide(t(i,i)),this},t.prototype.norm=t.prototype.normalize,t.prototype.limit=function(i,o){return Math.abs(this.x)>i&&(this.x*=o),Math.abs(this.y)>i&&(this.y*=o),this},t.prototype.randomize=function(i,o){return this.randomizeX(i,o),this.randomizeY(i,o),this},t.prototype.randomizeX=function(i,o){var c=Math.min(i.x,o.x),m=Math.max(i.x,o.x);return this.x=n(c,m),this},t.prototype.randomizeY=function(i,o){var c=Math.min(i.y,o.y),m=Math.max(i.y,o.y);return this.y=n(c,m),this},t.prototype.randomizeAny=function(i,o){return Math.round(Math.random())?this.randomizeX(i,o):this.randomizeY(i,o),this},t.prototype.unfloat=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},t.prototype.toFixed=function(i){return typeof i>"u"&&(i=8),this.x=this.x.toFixed(i),this.y=this.y.toFixed(i),this},t.prototype.mixX=function(i,o){return typeof o>"u"&&(o=.5),this.x=(1-o)*this.x+o*i.x,this},t.prototype.mixY=function(i,o){return typeof o>"u"&&(o=.5),this.y=(1-o)*this.y+o*i.y,this},t.prototype.mix=function(i,o){return this.mixX(i,o),this.mixY(i,o),this},t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.copyX=function(i){return this.x=i.x,this},t.prototype.copyY=function(i){return this.y=i.y,this},t.prototype.copy=function(i){return this.copyX(i),this.copyY(i),this},t.prototype.zero=function(){return this.x=this.y=0,this},t.prototype.dot=function(i){return this.x*i.x+this.y*i.y},t.prototype.cross=function(i){return this.x*i.y-this.y*i.x},t.prototype.projectOnto=function(i){var o=(this.x*i.x+this.y*i.y)/(i.x*i.x+i.y*i.y);return this.x=o*i.x,this.y=o*i.y,this},t.prototype.horizontalAngle=function(){return Math.atan2(this.y,this.x)},t.prototype.horizontalAngleDeg=function(){return s(this.horizontalAngle())},t.prototype.verticalAngle=function(){return Math.atan2(this.x,this.y)},t.prototype.verticalAngleDeg=function(){return s(this.verticalAngle())},t.prototype.angle=t.prototype.horizontalAngle,t.prototype.angleDeg=t.prototype.horizontalAngleDeg,t.prototype.direction=t.prototype.horizontalAngle,t.prototype.rotate=function(i){var o=this.x*Math.cos(i)-this.y*Math.sin(i),c=this.x*Math.sin(i)+this.y*Math.cos(i);return this.x=o,this.y=c,this},t.prototype.rotateDeg=function(i){return i=a(i),this.rotate(i)},t.prototype.rotateTo=function(i){return this.rotate(i-this.angle())},t.prototype.rotateToDeg=function(i){return i=a(i),this.rotateTo(i)},t.prototype.rotateBy=function(i){var o=this.angle()+i;return this.rotate(o)},t.prototype.rotateByDeg=function(i){return i=a(i),this.rotateBy(i)},t.prototype.distanceX=function(i){return this.x-i.x},t.prototype.absDistanceX=function(i){return Math.abs(this.distanceX(i))},t.prototype.distanceY=function(i){return this.y-i.y},t.prototype.absDistanceY=function(i){return Math.abs(this.distanceY(i))},t.prototype.distance=function(i){return Math.sqrt(this.distanceSq(i))},t.prototype.distanceSq=function(i){var o=this.distanceX(i),c=this.distanceY(i);return o*o+c*c},t.prototype.length=function(){return Math.sqrt(this.lengthSq())},t.prototype.lengthSq=function(){return this.x*this.x+this.y*this.y},t.prototype.magnitude=t.prototype.length,t.prototype.isZero=function(){return this.x===0&&this.y===0},t.prototype.isEqualTo=function(i){return this.x===i.x&&this.y===i.y},t.prototype.toString=function(){return"x:"+this.x+", y:"+this.y},t.prototype.toArray=function(){return[this.x,this.y]},t.prototype.toObject=function(){return{x:this.x,y:this.y}};var r=180/Math.PI;function n(i,o){return Math.floor(Math.random()*(o-i+1)+i)}function s(i){return i*r}function a(i){return i/r}})(f)),f.exports}var C=v();const h=w(C);function p(l,e,t){return Math.max(e,Math.min(t,l))}function M(l,e){return(l%e+e)%e}const u="http://www.w3.org/2000/svg";class b{pixelsPerMeter=8;meterCenter=new h(0,0);world;svg;constructor(e,t){this.world=e,this.svg=t,this.animate()}get pixelCenterCoords(){return new h(this.widthInPixels/2,this.heightInPixels/2)}animate(){this.draw(),requestAnimationFrame(()=>this.animate())}draw(){this.clearCanvas();const t=this.world.bodies[0].position.clone();this.meterCenter.x=p(this.meterCenter.x,t.x-15,t.x+15),this.meterCenter.y=p(this.meterCenter.y,t.y-15,t.y+15),this.drawAxis(),this.world.bodies.forEach(r=>{this.drawBody(r)})}clearCanvas(){this.svg.innerHTML=`  <defs>
    <marker id="arrowhead" orient="auto" markerWidth="10" markerHeight="7"
            refX="0" refY="2">
      <path d="M0,0 L4,2 L0,4 Z" fill="red" />
    </marker>
  </defs>`}drawRectangleInMeters(e,t,r,n,s){const a=this.meterCoordsToPixelCoords(e),i=t*this.pixelsPerMeter,o=r*this.pixelsPerMeter;this.drawRectangleInPixels(a,i,o,n*180/Math.PI,s)}drawDotInPixels(e,t,r){const n=document.createElementNS(u,"circle");n.setAttribute("cx",e.x.toString()),n.setAttribute("cy",e.y.toString()),n.setAttribute("r",t.toString()),n.setAttribute("fill",r),this.svg.appendChild(n)}drawRectangleInPixels(e,t,r,n,s){const a=`${-1*n} ${e.x} ${e.y}`,i=`${-1*t/2} ${-1*r/2}`,o=document.createElementNS(u,"rect");o.setAttribute("x",e.x.toString()),o.setAttribute("y",e.y.toString()),o.setAttribute("width",t.toString()),o.setAttribute("height",r.toString()),o.setAttribute("fill",s),o.setAttribute("transform",`rotate(${a}) translate(${i})`),this.svg.appendChild(o)}get widthInPixels(){return this.svg.clientWidth}get heightInPixels(){return this.svg.clientHeight}get widthInMeters(){return this.widthInPixels/this.pixelsPerMeter}get heightInMeters(){return this.heightInPixels/this.pixelsPerMeter}meterCoordsToPixelCoords(e){const t=this.pixelCenterCoords,r=t.x+(e.x-this.meterCenter.x)*this.pixelsPerMeter,n=t.y-(e.y-this.meterCenter.y)*this.pixelsPerMeter;return new h(r,n)}pixelCoordsToMeterCoords(e){return new h((e.x-this.widthInPixels/2)/this.pixelsPerMeter+this.meterCenter.x,(e.y-this.heightInPixels/2)/this.pixelsPerMeter+this.meterCenter.y)}get minXInMeters(){return this.meterCenter.x-this.widthInMeters/2}get maxXInMeters(){return this.meterCenter.x+this.widthInMeters/2}get minYInMeters(){return this.meterCenter.y-this.heightInMeters/2}get maxYInMeters(){return this.meterCenter.y+this.heightInMeters/2}addLineViaMeterCoords(e,t,r="black",n=1){const s=this.meterCoordsToPixelCoords(e),a=this.meterCoordsToPixelCoords(t);this.addLineViaPixelCoords(s,a,r,n)}addLineViaPixelCoords(e,t,r="black",n=1){const s=document.createElementNS(u,"line");s.setAttribute("x1",e.x.toString()),s.setAttribute("y1",e.y.toString()),s.setAttribute("x2",t.x.toString()),s.setAttribute("y2",t.y.toString()),s.setAttribute("stroke",r),s.setAttribute("stroke-width",n.toString()),this.svg.appendChild(s)}addArrowViaMeterCoords(e,t,r="black",n=1){const s=this.meterCoordsToPixelCoords(e),a=this.meterCoordsToPixelCoords(t);this.addArrowViaPixelCoords(s,a,r,n)}addArrowViaPixelCoords(e,t,r="black",n=1){const s=document.createElementNS(u,"line");s.setAttribute("x1",e.x.toString()),s.setAttribute("y1",e.y.toString()),s.setAttribute("x2",t.x.toString()),s.setAttribute("y2",t.y.toString()),s.setAttribute("stroke",r),s.setAttribute("stroke-width",n.toString()),s.setAttribute("marker-end","url(#arrowhead)"),this.svg.appendChild(s)}addHorizontalLineAtYMeters(e,t="black",r=1){const n=new h(this.minXInMeters,e),s=new h(this.maxXInMeters,e);this.addLineViaMeterCoords(n,s,t,r)}addVerticalLineAtXMeters(e,t="black",r=1){const n=new h(e,this.minYInMeters),s=new h(e,this.maxYInMeters);this.addLineViaMeterCoords(n,s,t,r)}addLabelAtMeterCoords(e,t,r,n=!1,s=!1){const a=this.meterCoordsToPixelCoords(e);this.addLabelAtPixelCoords(a,t,r,n,s)}addLabelAtPixelCoords(e,t,r,n=!1,s=!1){const a=document.createElementNS(u,"text");a.setAttribute("x",(e.x+2).toString()),a.setAttribute("y",(e.y-2).toString()),a.setAttribute("font-size","12"),a.setAttribute("fill",r),a.textContent=t,this.svg.appendChild(a);const i=a.getBBox();if(n){const o=p(e.x+2,0,this.widthInPixels-i.width);a.setAttribute("x",o.toString())}if(s){const o=p(e.y-2,0+i.height,this.heightInPixels);a.setAttribute("y",o.toString())}}drawAxis(){const e=10**Math.floor(Math.log10(this.heightInMeters-1)),t=10**Math.floor(Math.log10(this.widthInMeters-1)),r=Math.min(e,t),n=(Math.ceil(this.minXInMeters/r)-1)*r,s=(Math.floor(this.maxXInMeters/r)+1)*r,a=(Math.ceil(this.minYInMeters/r)-1)*r,i=(Math.floor(this.maxYInMeters/r)+1)*r;for(let o=a;o<=i;o+=r)this.addYTick(o);for(let o=n;o<=s;o+=r)this.addXTick(o)}addXTick(e){const t=e===0?"black":"grey",r=e===0?1:.5;this.addVerticalLineAtXMeters(e,t,r),this.addLabelAtMeterCoords(new h(e,0),e.toFixed(2),t,!0,!0)}addYTick(e){const t=e===0?"black":"grey",r=e===0?1:.5;this.addHorizontalLineAtYMeters(e,t,r),this.addLabelAtMeterCoords(new h(0,e),e.toFixed(2),t,!0,!0)}createRectElement(e){const t=document.createElementNS(u,"rect"),r=this.meterCoordsToPixelCoords(e.position),n=e.width*this.pixelsPerMeter,s=e.height*this.pixelsPerMeter;t.setAttribute("x",(r.x-n/2).toString()),t.setAttribute("y",(r.y-s/2).toString()),t.setAttribute("width",n.toString()),t.setAttribute("height",s.toString()),t.setAttribute("fill",e.color);const a=`${-1*e.angle*180/Math.PI} ${r.x} ${r.y}`;return t.setAttribute("transform",`rotate(${a})`),t}drawBody(e){const t=document.createElementNS(u,"g");e.rectangles.forEach(i=>{t.appendChild(this.createRectElement(i))});const r=this.meterCoordsToPixelCoords(e.position),n=`${-1*e.angle*180/Math.PI} ${r.x} ${r.y}`,s=`${e.position.x*this.pixelsPerMeter} ${-1*e.position.y*this.pixelsPerMeter}`;t.setAttribute("transform",`rotate(${n}) translate(${s})`),this.svg.appendChild(t),this.drawDotInPixels(this.meterCoordsToPixelCoords(e.position),3,"red");const a=.01;e.leverArms.forEach(i=>{if(i.force.length()<a)return;const o=e.position.clone().add(i.displacement),c=o.clone().add(i.force.clone().divideScalar(2e3));this.addArrowViaMeterCoords(o,c,"red",2)})}}class S{timestepSeconds=1/30;timestepMilliseconds=this.timestepSeconds*1e3;bodies;gravity=new h(0,9.81);minVelocity=2;minLinearAcceleration=.06;constructor(e=[]){this.bodies=e,setInterval(()=>this.run(),this.timestepMilliseconds)}run(){this.bodies.forEach(e=>this.updateBody(e))}updateBody(e){let t=new h(0,0),r=0;for(const n of e.leverArms)t.add(n.force),r+=n.torque;this.updateBodyLinear(e,t),this.updateBodyAngular(e,r)}barelyMovingLinear(e,t){return e.velocity.magnitude()<this.minVelocity&&t.magnitude()<this.minLinearAcceleration}updateBodyLinear(e,t){const r=t.divideScalar(e.mass);if(this.barelyMovingLinear(e,r)){e.velocity=new h(0,0);return}const n=r.clone().multiplyScalar(this.timestepSeconds);e.velocity.add(n);const s=e.velocity.clone().multiplyScalar(this.timestepSeconds);e.position.add(s)}updateBodyAngular(e,t){const r=t/e.momentOfInertia;e.angulerVelocity+=r*this.timestepSeconds,e.angle+=e.angulerVelocity*this.timestepSeconds}}class P{position=new h(0,0);velocity=new h(0,0);_angle=0;angulerVelocity=0;_mass=null;_momentOfInertia=null;id=crypto.randomUUID();get mass(){return this._mass===null&&(this._mass=this.calculateMass()),this._mass}get momentOfInertia(){return this._momentOfInertia===null&&(this._momentOfInertia=this.calculateMomentOfInertia()),this._momentOfInertia}get com(){return this.calculateCom()}getArm(e){return e.clone().subtract(this.com)}getTangentialVelocity(e){return this.getArm(e).multiplyScalar(this.angulerVelocity).rotate(Math.PI/2).rotate(this.angle)}getAbsoluteVelocity(e){const t=this.getTangentialVelocity(e);return this.velocity.clone().add(t)}calculateMass(){return this.rectangles.reduce((e,t)=>e+t.mass,0)}calculateCom(){let e=0,t=0,r=0;for(const a of this.rectangles)e+=a.mass,t+=a.mass*a.position.x,r+=a.mass*a.position.y;if(e===0)return new h(0,0);const n=t/e,s=r/e;return new h(n,s)}calculateMomentOfInertia(){const e=this.com;let t=0;for(const r of this.rectangles){const n=r.position.clone().subtract(e).magnitude(),s=1/12*r.mass*(r.width**2+r.height**2);t+=s+r.mass*n**2}return t}get angleInDegrees(){return this.angle*180/Math.PI}get angle(){return this._angle}set angle(e){this._angle=M(e,2*Math.PI)}}class d{displacement;force;constructor(e,t){this.displacement=e,this.force=t}get torque(){return this.displacement.cross(this.force)}}class A{width;height;position;mass;angle=0;_relativePositions=null;_com=null;color="blue";id=crypto.randomUUID();constructor(e,t,r,n,s=0,a="blue"){this.width=e,this.height=t,this.position=r,this.mass=n,this.angle=s||this.angle,this.color=a||this.color}get com(){return new h(this.width/2,this.height/2)}getRelativePositionUnrotated(e){return this.position.clone().subtract(e.com)}getArm(e){return this.getRelativePositionUnrotated(e).rotate(e.angle)}getAbsoluteAngle(e){return e.angle+this.angle}getAbsolutePosition(e){return this.getArm(e).add(e.position)}getTangentialVelocity(e){const t=this.getArm(e);return new h(-t.y,t.x).multiplyScalar(e.angulerVelocity)}getAbsoluteVelocity(e){return this.getTangentialVelocity(e).add(e.velocity)}}class y extends A{muStatic;constructor(e,t=.5,r=.5,n=15,s=500){super(r*2,t,e,n,0,"black"),this.muStatic=s}calculateForce(e,t){const r=M(t,2*Math.PI),n=e.angle()-r,s=-1*this.muStatic*Math.sin(n)*e.length(),a=t+Math.PI/2;return new h(s*Math.cos(a),s*Math.sin(a))}getLeverArm(e){const t=this.getAbsoluteVelocity(e),r=this.getAbsoluteAngle(e),n=this.calculateForce(t,r),s=this.getArm(e);return new d(s,n)}}class I extends P{controller=null;maxSteeringAngle=Math.PI/6;insideWheelSteeringMultiplier=1.3;chasisWidth=2;chasisLength=6;chasis=new A(this.chasisLength,this.chasisWidth,new h(0,0),1500,0,"lightblue");frontLeftWheel=new y(new h(this.chasisLength/3,this.chasisWidth/2));frontRightWheel=new y(new h(this.chasisLength/3,this.chasisWidth/-2));backLeftWheel=new y(new h(this.chasisLength/-3,this.chasisWidth/2));backRightWheel=new y(new h(this.chasisLength/-3,this.chasisWidth/-2));constructor(){super()}get rectangles(){return this.frontLeftWheel.angle=this.leftWheelAngle,this.frontRightWheel.angle=this.rightWheelAngle,[this.chasis,this.frontLeftWheel,this.frontRightWheel,this.backLeftWheel,this.backRightWheel]}get leftWheelAngle(){const e=this.getWheelAngle();return e>0?e*this.insideWheelSteeringMultiplier:e}get rightWheelAngle(){const e=this.getWheelAngle();return e<0?e*this.insideWheelSteeringMultiplier:e}get leverArms(){return[this.getThrottleLeverArm(),this.getDragLeverArm(),this.frontLeftWheel.getLeverArm(this),this.frontRightWheel.getLeverArm(this),this.backLeftWheel.getLeverArm(this),this.backRightWheel.getLeverArm(this)]}getSteeringLeverArm(){if(!this.controller)return new d(new h(0,0),new h(0,0));const e=new h(0,2).rotate(this.angle),t=this.controller.steering*500*this.velocity.magnitude();return new d(e,new h(0,t).rotate(this.angle+Math.PI/2))}getAngularDragLeverArm(){const e=new h(0,2).rotate(this.angle),t=-1e4*this.angulerVelocity*Math.abs(this.angulerVelocity);return new d(e,new h(0,t).rotate(this.angle+Math.PI/2))}getWheelAngle(){return this.controller?this.controller.steering*this.maxSteeringAngle:0}getDragLeverArm(){const t=25*this.velocity.magnitude()**2,n=this.velocity.clone().normalize().rotate(Math.PI).multiplyScalar(t);return new d(new h(0,0),n)}getThrottleLeverArm(){if(!this.controller)return new d(new h(0,0),new h(0,0));const e=new h(0,0),t=this.controller.r2*this.mass*40;return new d(e,new h(t,0).rotate(this.angle))}}class L{gamepad;throttleButtonIndex=7;steeringAxisIndex=0;deadZone=.03;constructor(e){console.log("Controller initialized with gamepad:",e.id),this.gamepad=e}updateGamepad(){const e=navigator.getGamepads()[this.gamepad.index];e&&(this.gamepad=e)}get throttle(){this.updateGamepad();const e=this.gamepad.buttons[this.throttleButtonIndex];return e&&Math.abs(e.value)>this.deadZone?e.value:0}get steering(){this.updateGamepad();const e=this.gamepad.axes[this.steeringAxisIndex];return e&&Math.abs(e)>this.deadZone?-1*e:0}get leftX(){return this.getAxesValue(0)}get leftY(){return this.getAxesValue(1)}get rightX(){return this.getAxesValue(2)}get rightY(){return this.getAxesValue(3)}get r1(){return this.getButtonValue(5)}get r2(){return this.getButtonValue(7)}get l1(){return this.getButtonValue(4)}get l2(){return this.getButtonValue(6)}getAxesValue(e){this.updateGamepad();const t=this.gamepad.axes[e];return t&&Math.abs(t)>this.deadZone?t:0}getButtonValue(e){this.updateGamepad();const t=this.gamepad.buttons[e];return t?t.value:0}}const g=new I;g.position.x=0;g.position.y=0;g.angle=90*Math.PI/180;const V=new S([g]);document.addEventListener("DOMContentLoaded",()=>{const l=document.getElementById("svgCanvas");if(!l)throw new Error("SVG canvas not found");new b(V,l).draw()});window.addEventListener("gamepadconnected",l=>{const e=l.gamepad;g.controller=new L(e),console.log(`Gamepad connected at index ${e.index}: ${e.id}.`)});
